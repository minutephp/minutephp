package com.greensock.loading.display {
    import flash.events.Event;
    import flash.events.ProgressEvent;
    import flash.system.Security;
    import flash.utils.setTimeout;

    import mx.controls.VideoDisplay;
    import mx.events.VideoEvent;

    public class YoutubePlayer extends VideoDisplay {
        public var buffer:int = 1;

        public var end:int = -1;

        public var start:int = 0;

        public var videoURL:String = '';

        public var vol:Number = 100;

        private var ready:Boolean = false;

        private var inited = false;
        
		private var active = false;

        public function YoutubePlayer() {
            super();

            width = 854;
            height = 480;
            alpha = 0;
            volume = 0;
            autoPlay = true;

            Security.allowDomain("*");
            Security.allowInsecureDomain("*");

            this.addEventListener(VideoEvent.PLAYHEAD_UPDATE, updatePlayer);
        }

        public function loadVideo():void {
            this.ready = false;
            this.source = 'http://www.stockutils.com/get-youtube-url?id=Q3xktII_PVY'; // this.videoURL;

            trace('loading started: http://www.stockutils.com/get-youtube-url?id=Q3xktII_PVY');
        }

        public function playVideo():void {
            if (this.ready) {
                trace('playing video..');
				active = true;
                this.play();
            } else {
                callLater(playVideo);
            }
        }

        protected function updatePlayer(event:VideoEvent):void {
            var time:Number = event.playheadTime;

            if (time > 0) {
                trace("play head:", event.playheadTime);

                if (!inited) {
                    inited = true;
                    this.end = Math.min(this.end || 300, this.totalTime || 300);
                    this.playheadTime = Math.max(this.end - 1, 0);
                    trace("end: ", this.end);
                } else {
                    if (!ready && Math.floor(event.playheadTime) >= this.end - 1) {
                        ready = true;
                        this.playheadTime = this.start;
                        this.pause();
                        this.volume = vol;
                        dispatchEvent(new Event(Event.COMPLETE));
                    } else if (active && (event.playheadTime > this.end || 999999)) {
                        trace('video pause...');
                        pause();
                    }
                }
            }
        }

        public function get duration():uint {
            return Math.max(1, end - start);
        }
    }
}
